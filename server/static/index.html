<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureVoice - –¢–µ—Å—Ç</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #111827;
            color: white;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .card {
            background: #1f2937;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }
        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
        }
        .btn:hover {
            background: #1d4ed8;
        }
        .input {
            background: #374151;
            border: 1px solid #4b5563;
            color: white;
            padding: 12px;
            border-radius: 8px;
            width: 100%;
            margin: 8px 0;
        }
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
        }
        .success { background: #065f46; }
        .error { background: #7f1d1d; }
        .info { background: #1e3a8a; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé§ SecureVoice</h1>
            <p>–ó–∞—â–∏—â–µ–Ω–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ –æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–æ–º–∞–Ω–¥</p>
        </div>

        <div class="card">
            <h2>–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</h2>
            <input type="text" id="roomName" class="input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã">
            <button onclick="createRoom()" class="btn">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
            <div id="createStatus"></div>
        </div>

        <div class="card">
            <h2>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ</h2>
            <input type="text" id="roomId" class="input" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã">
            <input type="text" id="userName" class="input" placeholder="–í–∞—à–µ –∏–º—è">
            <button onclick="joinRoom()" class="btn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
            <div id="joinStatus"></div>
        </div>

        <div class="card">
            <h2>–°–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç</h2>
            <button onclick="loadRooms()" class="btn">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            <div id="roomsList"></div>
        </div>

        <div class="card">
            <h2>WebSocket –¢–µ—Å—Ç</h2>
            <button onclick="testWebSocket()" class="btn">–¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</button>
            <div id="wsStatus"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let currentRoom = null;
        let ws = null;

        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        async function createRoom() {
            const roomName = document.getElementById('roomName').value;
            if (!roomName) {
                showStatus('createStatus', '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/rooms`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: roomName,
                        password: null,
                        max_participants: 10
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    currentRoom = data;
                    showStatus('createStatus', `–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞! ID: ${data.room_id}`, 'success');
                    document.getElementById('roomId').value = data.room_id;
                } else {
                    showStatus('createStatus', `–û—à–∏–±–∫–∞: ${data.detail}`, 'error');
                }
            } catch (error) {
                showStatus('createStatus', `–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function joinRoom() {
            const roomId = document.getElementById('roomId').value;
            const userName = document.getElementById('userName').value;
            
            if (!roomId || !userName) {
                showStatus('joinStatus', '–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã –∏ –≤–∞—à–µ –∏–º—è', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/rooms/${roomId}/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: userName,
                        password: null
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    currentRoom = data.room;
                    showStatus('joinStatus', `–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ: ${data.room.name}`, 'success');
                    connectWebSocket(roomId, data.user.id);
                } else {
                    showStatus('joinStatus', `–û—à–∏–±–∫–∞: ${data.detail}`, 'error');
                }
            } catch (error) {
                showStatus('joinStatus', `–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function loadRooms() {
            try {
                const response = await fetch(`${API_BASE}/rooms`);
                const data = await response.json();
                
                if (response.ok) {
                    const roomsList = document.getElementById('roomsList');
                    if (data.rooms.length === 0) {
                        roomsList.innerHTML = '<div class="status info">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç</div>';
                    } else {
                        roomsList.innerHTML = data.rooms.map(room => `
                            <div class="card" style="margin: 8px 0; padding: 16px;">
                                <h3>${room.name}</h3>
                                <p>ID: ${room.id}</p>
                                <p>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${room.participants.length}</p>
                                <p>–°—Ç–∞—Ç—É—Å: ${room.is_active ? '–ê–∫—Ç–∏–≤–Ω–∞' : '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞'}</p>
                            </div>
                        `).join('');
                    }
                } else {
                    showStatus('roomsList', `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–Ω–∞—Ç: ${data.detail}`, 'error');
                }
            } catch (error) {
                showStatus('roomsList', `–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        function connectWebSocket(roomId, userId) {
            if (ws) {
                ws.close();
            }

            ws = new WebSocket(`ws://localhost:8000/ws/${roomId}/${userId}`);
            
            ws.onopen = () => {
                showStatus('wsStatus', 'WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                showStatus('wsStatus', `–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${message.type}`, 'info');
            };

            ws.onclose = () => {
                showStatus('wsStatus', 'WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ', 'error');
            };

            ws.onerror = (error) => {
                showStatus('wsStatus', `WebSocket –æ—à–∏–±–∫–∞: ${error}`, 'error');
            };
        }

        function testWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'ping' }));
                showStatus('wsStatus', '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω ping', 'info');
            } else {
                showStatus('wsStatus', 'WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω', 'error');
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–Ω–∞—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = () => {
            loadRooms();
        };
    </script>
</body>
</html>

